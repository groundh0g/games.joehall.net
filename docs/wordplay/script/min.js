function DeserializeTile(a){var b=$.trim(a).split("|");var a=null;if(b.length>1){a=new WpTile(b[0],Math.floor(b[1]));a.PlayedBy=Math.floor(b[2]);a.PlayedAt=Math.floor(b[3]);a.PlayedOn=Math.floor(b[4])}return a}function SerializeTile(a){return a?a.Letter+"|"+a.Score+"|"+a.PlayedBy+"|"+a.PlayedAt+"|"+a.PlayedOn+"|":"[null]"}function RestoreState(){var a=$("#debugOut").val();var b=a.split("%");var c=[];var d=0;var e=b[1].split(",");var f=e.length;for(var g=1;g<f;g++){c[d++]=DeserializeTile(e[g])}gameInstance.UnplayedTiles=c;c=[];d=0;e=b[2].split(",");f=e.length;gameInstance.Players[0].Score=Math.floor(e[1]);for(var g=2;g<f;g++){c[d++]=DeserializeTile(e[g])}gameInstance.Players[0].Tiles=c;c=[];d=0;e=b[3].split(",");f=e.length;gameInstance.Players[1].Score=Math.floor(e[1]);for(var g=2;g<f;g++){c[d++]=DeserializeTile(e[g])}gameInstance.Players[1].Tiles=c;c=[];e=b[4].split(",");f=e.length;for(var g=1;g<f;g++){var h=DeserializeTile(e[g]);if(h){c[h.PlayedAt]=h}}gameInstance.Board.Tiles=c;gameInstance.UiDrawPlayerTiles();gameInstance.UiDrawBoardTiles(true);gameInstance.UiUpdateScores()}function SaveState(){if(!isDebugDivShown){var a=gameInstance.Players;var b=gameInstance.Board.Tiles;var c=gameInstance.UnplayedTiles;var d="WordPlay";d+="%UP";for(var e=0;e<c.length;e++){d+=","+SerializeTile(c[e])}d+="%P1,"+a[0].Score;for(var e=0;e<7;e++){d+=","+SerializeTile(a[0].Tiles[e])}d+="%P2,"+a[1].Score;for(var e=0;e<7;e++){d+=","+SerializeTile(a[1].Tiles[e])}d+="%BD";for(var e=0;e<15*15;e++){d+=","+SerializeTile(b[e])}$("#debugDiv").css("display","");$("#debugOut").text(d)}else{$("#debugDiv").css("display","none")}isDebugDivShown=!isDebugDivShown}function TileCombinations(a,b){this.N=a;this.R=b;this.A=[];var c=GetFactorial(a);var d=GetFactorial(b);var e=GetFactorial(a-b);this.Total=c/(d*e);this.NumLeft=this.Total;for(var f=0;f<b;f++){this.A[f]=f}this.Reset=function(){for(var a=0;a<this.R;a++){this.A[a]=a}};this.GetTotal=function(){return this.Total};this.GetNumLeft=function(){return this.NumLeft};this.HasMore=function(){return this.NumLeft>0?true:false};this.Next=function(){if(this.NumLeft==this.Total){this.NumLeft=this.NumLeft-1;return this.A}else{var a=this.R-1;while(this.A[a]==this.N-this.R+a){a=a-1}this.A[a]=this.A[a]+1;for(var b=a+1;b<this.R;b++){this.A[b]=this.A[a]+b-a}this.NumLeft=this.NumLeft-1;return this.A}}}function TilePermutations(a){this.A=[];this.NumLeft=0;this.Total=0;if(a>0){this.Total=GetFactorial(a);this.NumLeft=this.Total;for(var b=0;b<a;b++){this.A[b]=b}}this.Reset=function(){var a=this.A.length;for(var b=0;b<a;b++){this.A[b]=b}this.NumLeft=this.Total};this.HasMore=function(){return this.NumLeft>0};this.Next=function(){if(this.NumLeft==this.Total){this.NumLeft--;return this.A}else{var a=this.A;var b;var c=a.length-2;while(a[c]>a[c+1]){c--}var d=a.length-1;while(a[c]>a[d]){d--}b=a[d];a[d]=a[c];a[c]=b;var e=a.length-1;var f=c+1;while(e>f){b=a[f];a[f]=a[e];a[e]=b;e--;f++}this.NumLeft--;return a}}}function TilePermutationsOfCombinations(a,b,c){this.NumSteps=0;this.CurrentStep=0;this.Combos=[];this.ComboNum=0;var d=0;for(var e=b;e<=c;e++){this.Combos[d]=new TileCombinations(a,e);this.NumSteps+=this.Combos[d].GetTotal()*GetFactorial(e);d++}this.ComboIndexes=this.Combos[this.ComboNum].Next();this.CurrentPermute=new TilePermutations(this.ComboIndexes.length);this.CurrentStep++;this.GetProgress=function(){var a=0;var b=this.NumSteps;if(b>0){var c=Math.floor(100*this.CurrentStep/b);if(c>0){a=c}}return a};this.HasMore=function(){var a=this.Combos[this.ComboNum];var b=this.CurrentPermute;return a&&a.HasMore()||b&&b.HasMore()||a&&this.ComboNum<this.Combos.length};this.Next=function(){var a=this.CurrentPermute;var b=this.Combos[this.ComboNum];var c=[];if(!a.HasMore()){if(b){if(!b.HasMore()){this.ComboNum++;b=this.Combos[this.ComboNum];if(b){this.ComboIndexes=b.Next();this.CurrentPermute=new TilePermutations(this.ComboIndexes.length);a=this.CurrentPermute}else{};}else{this.ComboIndexes=b.Next();this.CurrentPermute=new TilePermutations(this.ComboIndexes.length);a=this.CurrentPermute}}else{};}if(a.HasMore()){var d=a.Next();this.CurrentStep++;var e=d.length;var f=this.ComboIndexes;for(var g=0;g<e;g++){c[g]=f[d[g]]}}return c}}function GetFactorial(a){var b=1;for(var c=a;c>1;c--){b=b*c}return b}function FindValidFirstMoves(){var a=[];var b=gameInstance.Board.Tiles;var c=7+7*15;var d=15*15;var e=0;if(!b[c]){a[e++]={Index:c}}else{for(var f=0;f<d;f++){if(!b[f]){if(Math.floor(f%15)>0&&b[f-1]){a[e++]={Index:f}}else if(f>14&&b[f-15]){a[e++]={Index:f}}else if(Math.floor(f%15)<14&&b[f+1]){a[e++]={Index:f}}else if(f<210&&b[f+15]){a[e++]={Index:f}}}}}var g=0;var h=0;for(var f=0;f<e;f++){var i=a[f];var j=i.Index;var k=j-Math.floor(j%15);d=k+15;var l=[];for(h=j-1,g=0;h>=k&&g<7;h--){if(!b[h]){l.splice(0,0,h);g++}}i.OpenCellsLeft=l;l=[];for(h=j,g=0;h<d&&g<8;h++){if(!b[h]){l[g++]=h}}i.OpenCellsRight=l;k=Math.floor(j%15);d=15*15;l=[];for(h=j,g=0;h>=k&&g<7;h-=15){if(!b[h]){l.splice(0,0,h);g++}}i.OpenCellsUp=l;l=[];for(h=j,g=0;h<d&&g<8;h+=15){if(!b[h]){l[g++]=h}}i.OpenCellsDown=l}return a}function StartAI_Hint(){for(var a=0;a<7;a++){gameInstance.UiRevertPlayerTile(a,false)}gameInstance.UiToggleButtons();StartAI(["bogus value"])}function StartAI(a){if(!gameInstance.EndGame){TaskAI=new Task(function(a){gameInstance_AI={};var b=gameInstance_AI;b.TimeStart=(new Date).getTime();var c=gameInstance.Players[1].Tiles.length;var d=gameInstance.AiDifficulty;b.PlayerIndex=1;b.TargetWordLength=-1;b.TargetWordScore=-1;if(a&&a.length>0){b.PlayerIndex=0;d=7}else{if(d==7){b.TargetScore=Math.max(gameInstance.Players[0].Score+1,15)}else if(d==0){d=2;b.TargetWordLength=4;b.TargetWordScore=Math.max(gameInstance.Players[0].Score,15)}}d++;if(d>c){d=c}b.BestScore=0;b.BestTilesPlayed=[];b.BestTilesPlayedAt=[];b.PlayFound=false;b.Progress=0;b.ValidFirstMoves=FindValidFirstMoves();if(b.ValidFirstMoves.length>0){var e=1;var f=0;if(!gameInstance.Board.Tiles[7+7*15]&&d>1){e=2}b.PermutationManager=new TilePermutationsOfCombinations(c,e,d)}gameInstance.UiPrepForAI(true)},function(){var a=gameInstance_AI;var b={cellMin:{X:-1,Y:-1,I:-1},cellMax:{X:-1,Y:-1,I:-1},tilesPlayed:[],isValidTilePlacement:true,errorMsg:null};if(a.PermutationManager.HasMore()){var c=a.PermutationManager.Next();var d=a.PermutationManager.GetProgress();if(d!=a.Progress){$("#aiProgress").css("width",d+"%");a.Progress=d;if(d>5){var e=((new Date).getTime()-a.TimeStart)/1e3;var f=Math.floor(100*e/d-e)+1;$("#lblTimeLeft").html(gameInstance.MakeNumberSprites(f))}}var g=c.length;var h=a.ValidFirstMoves;var i=h.length;var j=false;var k=gameInstance.Board.Tiles;var l=gameInstance.Players[a.PlayerIndex].Tiles;for(var m=0;m<i;m++){var n=h[m];for(var o=0;o<g;o++){for(var p=0;p<2;p++){var q=p==0?true:false;var r=q?1:15;var s=q?n.OpenCellsLeft:n.OpenCellsUp;var t=q?n.OpenCellsRight:n.OpenCellsDown;var u=s.length;var v=t.length;var w=-1;j=v>=g-o&&u>=o;if(j){b.cellMin.I=o>0?s[u-o]:t[0];b.cellMax.I=t[g-1-o];for(var x=0;x<g;x++){var y=l[c[x]];y.PlayedAt=x-o>=0?t[x-o]:s[u+(x-o)]}b.tilesPlayed=c;gameInstance.ValidateWordsPlayed(a.PlayerIndex,b);var z=b.isValidAllWords;var A="";if(z){A=b.WordsPlayed[0]}if(z&&a.PlayFound){var B=gameInstance.Players[1-a.PlayerIndex].Score;var C=b.Score;var D=a.BestScore;var E=a.TargetWordScore;z=false;if(E>0){var F=Math.abs(E-(B+C));var G=Math.abs(E-(B+D));if(F==G){var H=a.TargetWordLength;if(H>0){F=Math.abs(H-A.length);G=Math.abs(H-a.BestWordLength);if(F<G){z=true}}}else if(F<G){z=true}}else if(C>D){z=true}}if(z){var I=c.length;var J=[];var K=[];for(var L=0;L<I;L++){J[L]=c[L];K[L]=l[c[L]].PlayedAt}a.BestTilesPlayed=J;a.BestTilesPlayedAt=K;a.BestScore=b.Score;a.BestWordLength=A.length;a.PlayFound=true}}}}}}else{this.IsRunning=false;this.Result=0;if(this.OnDone){this.OnDone()}}},function(){var a=gameInstance_AI;var b=gameInstance.Players[a.PlayerIndex].Tiles;var c=b.length;if(a.PlayFound){var d=a.BestTilesPlayed;var e=d.length;for(var f=0;f<c;f++){b[f].Reset()}for(var f=0;f<e;f++){b[d[f]].PlayedAt=a.BestTilesPlayedAt[f]}if(a.PlayerIndex==1){gameInstance.CommitPlayedTiles(1);gameInstance.Players[1].Score+=a.BestScore;for(var f=0;f<c;f++){if(b[f]){b[f].Reset()}}gameInstance.UiUpdateScores();gameInstance.UiPrepForAI(false);gameInstance.UiDrawBoardTiles(true)}else{gameInstance.UiDrawHintTiles();gameInstance.UiPrepForAI(false)}}else{for(var f=0;f<c;f++){b[f].Reset()}gameInstance.UiSkipTurn(1);gameInstance.UiPrepForAI(false);gameInstance.UiDrawBoardTiles(true)}},function(){});TaskAI.StartTask(a)}}function WordPlay(){this.WasHandleDropCalled=false;this.TurnNumber=0;this.Board=null;this.Players=null;this.UnplayedTiles=null;this.AiDifficulty=3;this.SetAiDifficulty=function(a){this.AiDifficulty=a;this.UiUpdateHud()};this.MakeNumberSprites=function(a){var b="";a=Math.floor(a);while(a>0){b="<div class='textSprite txtNum"+Math.floor(a%10)+"'></div>"+b;a=Math.floor(a/10)}if(b.length==0){b="<div class='textSprite txtNum0'></div>"}return b};this.UiUpdateHud=function(){$("#scorePlayer").html(this.MakeNumberSprites(this.Players[0].Score));$("#scoreCPU").html(this.MakeNumberSprites(this.Players[1].Score));$("#tilesLeft").html(this.MakeNumberSprites(this.UnplayedTiles.length));var a=this.AiDifficulty;var b="";switch(a){case 0:b="txtDiffEasiest";break;case 1:b="txtDiffEasier";break;case 2:b="txtDiffEasy";break;case 3:b="txtDiffNormal";break;case 4:b="txtDiffHard";break;case 5:b="txtDiffHarder";break;case 6:b="txtDiffHardest";break;case 7:b="txtDiffMatchMe";break}$("#lblDiff").attr("class","textSprite "+b);for(var c=0;c<8;c++){$("#dif"+c).attr("class","aiDifficultyCell"+(c==a?" sprite difficultySlider":""))}b="txtWaitingOnPlayer";if(TaskAI&&TaskAI.IsRunning){b="txtThinking"}else if(this.EndGame){if(this.Players[0].Score>this.Players[1].Score){b="txtEndGameWon"}else if(this.Players[1].Score>this.Players[0].Score){b="txtEndGameLost"}else{b="txtEndGameTie"}}$("#lblMsg").attr("class","textSprite "+b);$("#lblTimeLeft").html("")};this.RefillPlayerTiles=function(){var a=this.Players[0].Tiles.length;var b=this.Players[1].Tiles.length;var c=this.UnplayedTiles.length;while(c>0&&(a<7||b<7)){if(a<7){this.Players[0].Tiles[a]=this.UnplayedTiles[0];this.UnplayedTiles.splice(0,1);a++;c--}if(b<7&&c>0){this.Players[1].Tiles[b]=this.UnplayedTiles[0];this.UnplayedTiles.splice(0,1);b++;c--}}};this.Reset=function(){this.WasHandleDropCalled=false;this.TurnNumber=0;this.Board=new WpBoard;this.Players=[new WpPlayer("Player 1",null,0),new WpPlayer("Player 2",null,1)];this.UnplayedTiles=[new WpTile("A",1),new WpTile("A",1),new WpTile("A",1),new WpTile("A",1),new WpTile("A",1),new WpTile("A",1),new WpTile("A",1),new WpTile("A",1),new WpTile("A",1),new WpTile("B",3),new WpTile("B",3),new WpTile("C",3),new WpTile("C",3),new WpTile("D",2),new WpTile("D",2),new WpTile("D",2),new WpTile("D",2),new WpTile("E",1),new WpTile("E",1),new WpTile("E",1),new WpTile("E",1),new WpTile("E",1),new WpTile("E",1),new WpTile("E",1),new WpTile("E",1),new WpTile("E",1),new WpTile("E",1),new WpTile("E",1),new WpTile("E",1),new WpTile("F",4),new WpTile("F",4),new WpTile("G",2),new WpTile("G",2),new WpTile("G",2),new WpTile("H",4),new WpTile("H",4),new WpTile("I",1),new WpTile("I",1),new WpTile("I",1),new WpTile("I",1),new WpTile("I",1),new WpTile("I",1),new WpTile("I",1),new WpTile("I",1),new WpTile("I",1),new WpTile("J",7),new WpTile("K",5),new WpTile("L",1),new WpTile("L",1),new WpTile("L",1),new WpTile("L",1),new WpTile("M",3),new WpTile("M",3),new WpTile("N",1),new WpTile("N",1),new WpTile("N",1),new WpTile("N",1),new WpTile("N",1),new WpTile("N",1),new WpTile("O",1),new WpTile("O",1),new WpTile("O",1),new WpTile("O",1),new WpTile("O",1),new WpTile("O",1),new WpTile("O",1),new WpTile("O",1),new WpTile("P",3),new WpTile("P",3),new WpTile("Q",9),new WpTile("R",1),new WpTile("R",1),new WpTile("R",1),new WpTile("R",1),new WpTile("R",1),new WpTile("R",1),new WpTile("S",1),new WpTile("S",1),new WpTile("S",1),new WpTile("S",1),new WpTile("T",1),new WpTile("T",1),new WpTile("T",1),new WpTile("T",1),new WpTile("T",1),new WpTile("T",1),new WpTile("U",1),new WpTile("U",1),new WpTile("U",1),new WpTile("U",1),new WpTile("V",4),new WpTile("V",4),new WpTile("W",4),new WpTile("W",4),new WpTile("X",7),new WpTile("Y",4),new WpTile("Y",4),new WpTile("Z",9)];var a=this.UnplayedTiles;var b=a.length;for(var c=0;c<b;c++){a[c].WoodTile=c%4+1}for(var d=0;d<7;d++){for(var e=0;e<b;e++){var f=Math.floor(Math.random()*b);var g=a[f];a[f]=a[e];a[e]=g}}this.RefillPlayerTiles()};this.Reset();this.UiRevertPlayerTile=function(a,b){var c="#p"+a;var d=this.Players[0].Tiles[a];var e=d?"cell sprite wood"+d.WoodTile:"";$(c).attr("class",e);var f=b?333:0;$(c).animate({top:0,left:0},f);var d=this.Players[0].Tiles[a];if(d){d.Reset()}};this.UiRevertPlayerTiles=function(){for(var a=0;a<7;a++){this.UiRevertPlayerTile(a,true)}this.UiToggleButtons()};this.UiCreatePlayerTiles=function(){$("#playerTiles").html(" ");for(var a=0;a<7;a++){var b="p"+a;var c=this.Players[0].Tiles[a];var d=c?"sprite wood"+c.WoodTile:"";$("<div class='cell "+d+"'> </div>").data("tileIndex",a).attr("id",b).appendTo("#playerTiles").draggable({containment:"#content",stack:"#playerTiles div",cursor:"move",revert:true,stop:function(a,b){if(!gameInstance.WasHandleDropCalled){var c=b.helper.attr("id");var d=parseInt(c.substring(1));gameInstance.UiRevertPlayerTile(d,true)}gameInstance.UiToggleButtons()},start:function(a,b){gameInstance.WasHandleDropCalled=false}})}};this.UiHandleDrop=function(a,b){var c=b.draggable.data("tileIndex");var d=gameInstance.Players[0].Tiles[c];var e=$(this).attr("id");if(e&&e.substring(0,1)=="x"){var f=parseInt(e.substring(1,e.indexOf("y")));var g=parseInt(e.substring(e.indexOf("y")+1));var h=f+g*15;var i=gameInstance.Board.Tiles[h]==null?false:true;if(!i){for(var j=0;j<7;j++){var k=gameInstance.Players[0].Tiles[j];if(j!=c&&k&&k.PlayedAt==h){i=true;break}}if(!i){d.PlayedAt=h;var k=d;var l=k?" cell sprite wood"+k.WoodTile:"";b.draggable.attr("class","boardCellPlaying"+l);b.draggable.position({of:$(this),my:"left top",at:"left top"});b.draggable.draggable("option","revert",false);gameInstance.WasHandleDropCalled=true}}}};this.UiCreateBoardTiles=function(){$("#boardTiles").html("");for(var a=0;a<15;a++){for(var b=0;b<15;b++){var c="x"+b+"y"+a;$("<div class='cell sprite cellEmpty'> </div>").attr("id",c).css("float","left").appendTo("#boardTiles").droppable({accept:"#playerTiles div",hoverClass:"hovered",drop:gameInstance.UiHandleDrop})}}};this.UiDrawPlayerTiles=function(){var a=this.Players[0].Tiles;for(var b=0;b<7;b++){var c="#p"+b;var d="";if(a){var e=a[b];if(e){d="<span class='letterTile'>"+e.Letter.toUpperCase()+"</span><span class='letterScore'>"+e.Score+"</span>";$(c).css("display","")}else{$(c).css("display","none")}}var e=this.Players[0].Tiles[b];var f=e?"cell sprite wood"+e.WoodTile:"";$(c).html(d);$(c).attr("class",d.length>0?f:"cell sprite cellEmpty")}};this.UiDrawBoardTiles=function(a){var b=this.Board;var c=b.Tiles;var d=this.TurnNumber-1;for(var e=0;e<15;e++){for(var f=0;f<15;f++){var g="#x"+f+"y"+e;var h="";var i="cell sprite cellEmpty";if(a&&c){var j=c[f+e*15];if(j){i="cell sprite wood"+j.WoodTile+(j.PlayedOn==d?"Played":"");h="<span class='letterTile'>"+j.Letter.toUpperCase()+"</span><span class='letterScore'>"+j.Score+"</span>"}}if(a&&h.length==0){var k=b.SpecialCells[g];if(k){i="cell sprite "+k.cls}}$(g).html(h);$(g).attr("class",i)}}};this.UiEnableDragAndDrop=function(a){for(var b=0;b<7;b++){var c="#p"+b;var d=this.Players[0].Tiles[b];var e=d?"cell sprite wood"+d.WoodTile:"";$(c).draggable(a?"enable":"disable");$(c).attr("class",a?e:"cell sprite cellEmpty")}};this.UiReset=function(){this.UiCreatePlayerTiles();this.UiCreateBoardTiles();this.Reset();this.UiDrawPlayerTiles();this.UiDrawBoardTiles(true)};this.NumTilesPlayed=function(){var a=0;var b=this.Players[0].Tiles;var c=b.length;for(var d=0;d<c;d++){if(b[d].PlayedAt!=-1){a++}}return a};this.UiToggleButtons=function(){if(this.NumTilesPlayed()>0){$("#cmdSkip").css("display","none");$("#cmdSwap").css("display","none");$("#cmdPlay").css("display","");$("#cmdUndo").css("display","")}else{$("#cmdPlay").css("display","none");$("#cmdUndo").css("display","none");$("#cmdSkip").css("display","");$("#cmdSwap").css("display","")}};this.UiUpdateScores=function(){var a=gameInstance.Players;var b=gameInstance.UnplayedTiles.length;var c=true;c&=!gameInstance.EndGame;c&=!b;c&=!a[0].Tiles.length||!a[1].Tiles.length;if(c){var d=a[0].Tiles.length==0?0:1;if(a[d].Tiles.length==0){var e=0;var f=a[1-d].Tiles;for(var g=0;g<f.length;g++){e+=f[g].Score}a[d].Score+=e}gameInstance.EndGame=true}gameInstance.UiUpdateHud()};this.UiPrepForAI=function(a){var b=a?"disable":"enable";gameInstance.UiEnableDragAndDrop(a?false:true);$("#allTabs").css("display",a?"none":"");$("#allDif").css("display",a?"none":"");$("#aiProgress").css("width","1%");gameInstance.UiUpdateHud();if(a){$("#lblMsg").attr("class","textSprite txtThinking")}};this.ValidatePlayerMove=function(){if(!this.EndGame){var a=this.ValidateTilePlacement(0);if(!a.isValidTilePlacement){alert(a.errorMsg)}else{this.ValidateWordsPlayed(0,a);if(a.isValidAllWords){this.Players[0].Score+=a.Score;this.CommitPlayedTiles(0);this.UiToggleButtons();this.UiDrawPlayerTiles();this.UiDrawBoardTiles(true);this.UiUpdateScores();StartAI()}if(a.errorMsg){alert(a.errorMsg)}}}};this.ValidateTilePlacement=function(a){var b={cellMin:{X:-1,Y:-1,I:-1},cellMax:{X:-1,Y:-1,I:-1},tilesPlayed:[],isValidTilePlacement:false,errorMsg:null};var c=0;var d=false;var e=this.Players[0].Score==0&&this.Players[1].Score==0?true:false;var f=0;var g=this.Players[a].Tiles.length;while(c<g){var h=this.Players[a].Tiles[c];var i=h.PlayedAt;if(i>=0){b.tilesPlayed[f]=c;f++;var j=Math.floor(i%15);var k=Math.floor(i/15);if(b.cellMin.I==-1||i<b.cellMin.I){b.cellMin.I=i;b.cellMin.X=j;b.cellMin.Y=k}if(b.cellMax.I==-1||i>b.cellMax.I){b.cellMax.I=i;b.cellMax.X=j;b.cellMax.Y=k}if(j==7&&k==7){d=true}}c++}if(b.cellMin.I!=-1&&b.cellMax.I!=-1){if(b.cellMin.I==b.cellMax.I&&e){b.errorMsg="You must place more than one tile."}else if(e&&!d){b.errorMsg="The first word played must touch the center tile."}else{var l=b.cellMax.X-b.cellMin.X;var m=b.cellMax.Y-b.cellMin.Y;if(l==0&&m==0){b.isValidTilePlacement=true}if(!b.isValidTilePlacement){var n=0;if(l==0){n=15}else if(m==0){n=1}else{b.errorMsg="Tiles must be played in a row (horizontal or vertical)."}if(n>0){var o=true;var p=b.cellMax.I;c=b.cellMin.I;while(c<=p){if(!o){break}o=false;if(this.Board.Tiles[c]){o=true}else{for(var q=0;q<f;q++){if(c==this.Players[a].Tiles[b.tilesPlayed[q]].PlayedAt){o=true;break}}}c+=n}if(o){b.isValidTilePlacement=true}else{b.errorMsg="Tile must be contiguous (no gaps)."}}}if(b.isValidTilePlacement&&!e){var o=false;for(var q=0;q<f;q++){c=this.Players[a].Tiles[b.tilesPlayed[q]].PlayedAt;var r=Math.floor(c%15);var s=Math.floor(c/15);if(r>0&&this.Board.Tiles[c-1]){o=true;break}else if(s>0&&this.Board.Tiles[c-15]){o=true;break}else if(r<14&&this.Board.Tiles[c+1]){o=true;break}else if(s<14&&this.Board.Tiles[c+15]){o=true;break}}if(!o){b.isValidTilePlacement=false;b.errorMsg="At least one of the played tiles must be placed next to an existing tile."}}}}else{b.errorMsg="No tiles were placed? Strange."}return b};this.ValidateWordsPlayed=function(a,b){if(b){b.wordsPlayed=[];b.isValidAllWords=false;b.Score=0;var c=b.tilesPlayed;var d=b.cellMin.X;var e=b.cellMax.X;var f=b.cellMin.Y;var g=b.cellMax.Y;var h=b.cellMin.I;var i=b.cellMax.I;if(h>=0){if(d==-1){d=Math.floor(h%15)}if(f==-1){f=Math.floor(h/15)}}if(i>=0){if(e==-1){e=Math.floor(i%15)}if(g==-1){g=Math.floor(i/15)}}var j=0;if(h==i){if(this.GetTile(a,c,h-1)||this.GetTile(a,c,h+1)){j=1}else if(this.GetTile(a,c,h-15)||this.GetTile(a,c,h+15)){j=15}else{b.errorMsg="One tile played. Doesn't touch an already-played tile."}}else{if(e==d){j=15}else if(g==f){j=1}else{b.errorMsg="Tiles don't appear to be colinear."}}if(j>0){var k=0;var l=1;var m=0;var n=this.FindFirstWordTile(a,c,h,j);var o=[];var p=0;var q=[];var r=0;var s=n.PlayedAt;var t=16-j;var u=this.ScanForWord(a,c,s,j);if(WordHelper.FindWord(u)<0){b.errorMsg="'"+u+"' is not a valid word."}else{var v=u.length;var w=this.Board.Tiles;q[r++]=u;var x=0;for(var y=s;y<s+v*j;y+=j){n=this.GetTile(a,c,y);m=n.Score;if(!w[y]){x++;var z=this.Board.SpecialCells["#x"+Math.floor(y%15)+"y"+Math.floor(y/15)];if(z){switch(z.txt){case"DL":m=m*2;break;case"TL":m=m*3;break;case"DW":l=l*2;break;case"TW":l=l*3;break}}var A=t==15?0:y-Math.floor(y%15);var B=(t==15?15*15:y-Math.floor(y%15)+15)-1;if(y>A&&w[y-t]){o[p++]=y}else if(y<B&&w[y+t]){o[p++]=y}}k=k+m}k*=l;if(x==7){k+=50}var C=true;for(var y=0;y<p;y++){n=this.FindFirstWordTile(a,c,o[y],t);s=n.PlayedAt;u=this.ScanForWord(a,c,s,t);v=u.length;q[r++]=u;if(WordHelper.FindWord(u)<0){C=false;b.errorMsg="'"+u+"' is not a valid word..";break}else{var D=0;l=1;for(var E=s;E<s+v*t;E+=t){n=this.GetTile(a,c,E);m=n.Score;if(!w[E]){var z=this.Board.SpecialCells["#x"+Math.floor(E%15)+"y"+Math.floor(E/15)];if(z){switch(z.txt){case"DL":m=m*2;break;case"TL":m=m*3;break;case"DW":l=l*2;break;case"TW":l=l*3;break}}}D+=m}k+=D*l}}if(C){b.isValidAllWords=true;b.Score=k}}b.WordsPlayed=q}}else{b={cellMin:{X:-1,Y:-1,I:-1},cellMax:{X:-1,Y:-1,I:-1},tilesPlayed:[],isValidTilePlacement:false,wordsPlayed:[],isValidAllWords:false,errorMsg:"ValidateTilePlacement must be called before ValidateWordsPlayed.",Score:0}}return b};this.Log=function(a){if(console&&console.log){console.log(a)}};this.GetTile=function(a,b,c){var d=this.Board.Tiles[c];if(!d){var e=b.length;for(var f=0;f<e;f++){d=this.Players[a].Tiles[b[f]];if(d.PlayedAt==c){break}d=null}}return d};this.FindFirstWordTile=function(a,b,c,d){var e=this.GetTile(a,b,c);var f=d==1?c-Math.floor(c%15):0;while(c>f){c-=d;var g=this.GetTile(a,b,c);if(g){e=g}else{break}}return e};this.ScanForWord=function(a,b,c,d){var e="";var f=d==1?c+15-Math.floor(c%15):15*15;var g=this.GetTile(a,b,c);while(g&&c<f){e+=g.Letter;c+=d;g=this.GetTile(a,b,c)}return e};this.CommitPlayedTiles=function(a){var b=this.Players[a].Tiles;var c=[];var d=b.length;var e=0;for(var f=0;f<d;f++){var g=b[f];if(g.PlayedAt>=0){this.Board.Tiles[g.PlayedAt]=g;g.PlayedOn=this.TurnNumber;g.PlayedBy=a;b[f]=null;gameInstance.UiRevertPlayerTile(f,false)}else{c[e]=g;e++}}this.Players[a].Tiles=c;this.RefillPlayerTiles();this.TurnNumber++};this.UiDrawHintTiles=function(){var a=this.Players[0].Tiles;var b=a.length;var c=this.Board.Tiles;for(var d=0;d<b;d++){var e=a[d].PlayedAt;if(e>=0){var f=a[d];var g="#x"+Math.floor(e%15)+"y"+Math.floor(e/15);var h="<span class='letterTile'>"+f.Letter.toUpperCase()+"</span><span class='letterScore'>"+f.Score+"</span>";var i="cell sprite cellEmpty";$(g).html(h);$(g).attr("class",i);f.Reset()}}};this.UiSkipTurn=function(a){if(!gameInstance.EndGame){this.TurnNumber++;var b=gameInstance.Players[a].Tiles;if(a==0){for(var c=0;c<7;c++){gameInstance.UiRevertPlayerTile(c,false)}}else{for(var c=0;c<7;c++){if(b[c]){b[c].Reset()}}}gameInstance.UiUpdateScores();gameInstance.UiToggleButtons();gameInstance.UiDrawPlayerTiles();gameInstance.UiDrawBoardTiles(true);if(a==0){gameInstance.UiPrepForAI(true);StartAI()}else{gameInstance.UiPrepForAI(false)}}}}function WpBoard(){this.Tiles=[]}function WpTile(a,b){this.Letter=a.toLowerCase();this.Score=b;this.WoodTile=1;this.PlayedAt=-1;this.PlayedBy=-1;this.PlayedOn=-1;this.Reset=function(){this.PlayedAt=this.PlayedBy=this.PlayedOn=-1}}function WpPlayer(a,b,c){this.Name=a?""+a:"Guest";this.AiTask=b?b:null;this.Index=c?parseInt(c):-1;this.Score=0;this.Tiles=[]}function InitGame(){var a=3;if(gameInstance&&gameInstance.AiDifficulty){a=gameInstance.AiDifficulty}gameInstance=new WordPlay;gameInstance.UiReset();$("#aiMessage").text("Waiting on player.");gameInstance.UiUpdateScores();gameInstance.UiToggleButtons();gameInstance.SetAiDifficulty(a)}function Task(a,b,c,d){this.IsInitialized=false;this.IsRunning=false;this.Result=-1;this.ErrorMessage=null;this.TaskCounter=0;this.Timer=null;this.OnInit=a;this.OnDoTask=b;this.OnDone=c;this.OnError=d}Task.prototype.Initialize=function(a){if(this.OnInit){this.OnInit(a)}this.IsInitialized=true;this.IsRunning=false;this.Result=-1;this.ErrorMessage=null;this.TaskCounter=0};Task.prototype.DoTask=function(){if(this.OnDoTask){this.IsRunning=true;this.OnDoTask();this.TaskCounter++}else{this.IsRunning=false;this.ErrorMessage="Nothing to do.";if(this.OnError){this.OnError()}}if(this.IsRunning){var a=this;this.Timer=setTimeout(function(){a.DoTask()},1)}else{if(this.Timer){clearTimeout(this.Timer)}this.Timer=null}};Task.prototype.StartTask=function(a){this.Initialize(a);this.DoTask()};var WordHelper={WordList:new Array,WordListCount:function(){var a=0;for(var b in this.WordList){a++}return a},FindWord:function(a){var b=-1;if(a&&a.length>1){var c=a.charAt(0)+a.length;var d=this.WordList[c];if(d&&d.length>0){b=this.BinaryWordSearch(d,a.substring(1))}}return b},BinaryWordSearch:function(a,b){var c=-1;var d=b.length;var e=a.length;var f=0;var g=Math.floor(e/d-1);var h=0;var i=false;while(g>=f){h=Math.floor((f+g)/2);c=h*d;var j=a.substring(c,c+d);i=true;for(var k=0;k<d;k++){if(b.charAt(k)!=j.charAt(k)){i=false;if(b.charAt(k)<j.charAt(k)){g=h-1}else{f=h+1}break}}if(i){g=-1}}if(!i){c=-1}return c}};var TaskLoadWords=new Task(function(a){this.Alphabet="abcdefghijklmnopqrstuvwxyz";this.AlphaIndex=0;this.MinLen=2;this.MaxLen=15;this.LenIndex=this.MinLen;this._total=this.Alphabet.length*(this.MaxLen-this.MinLen+1);$("#loadingMessage").text("Initializing Loader");$("#loadingProgress").width(0)},function(){var a=this.Alphabet.charAt(this.AlphaIndex);var b="words/"+this.LenIndex+"/"+a+".txt";var c=a+this.LenIndex;jQuery.ajax({url:b,dataType:"text",success:function(a){WordHelper.WordList[c]=""+a},async:false});this.LenIndex++;if(this.LenIndex>this.MaxLen){this.LenIndex=this.MinLen;this.AlphaIndex++}if(this.AlphaIndex>=this.Alphabet.length){this.IsRunning=false;this.Result=0;if(this.OnDone){this.OnDone()}}var d=this.AlphaIndex*(this.MaxLen-this.MinLen)+this.LenIndex-this.MinLen;var e=Math.floor(100*d/this._total);$("#loadingMessage").text("Loading "+d+" of "+this._total+".");$("#loadingProgress").css("width",e+"%")},function(){$("#loadingPanel").hide();$("#boardPanel").show();InitGame()},function(){});var gameInstance=null;WpBoard.prototype.UiInitDroppable=function(){for(var a=0;a<15;a++){for(var b=0;b<15;b++){var c="#x"+b+"y"+a;$(c).droppable()}}};WpBoard.prototype.SpecialCells={"#x0y3":{txt:"TW",cls:"cellTW"},"#x3y0":{txt:"TW",cls:"cellTW"},"#x3y14":{txt:"TW",cls:"cellTW"},"#x14y3":{txt:"TW",cls:"cellTW"},"#x0y11":{txt:"TW",cls:"cellTW"},"#x11y0":{txt:"TW",cls:"cellTW"},"#x14y11":{txt:"TW",cls:"cellTW"},"#x11y14":{txt:"TW",cls:"cellTW"},"#x5y1":{txt:"DW",cls:"cellDW"},"#x9y1":{txt:"DW",cls:"cellDW"},"#x7y3":{txt:"DW",cls:"cellDW"},"#x1y5":{txt:"DW",cls:"cellDW"},"#x1y9":{txt:"DW",cls:"cellDW"},"#x3y7":{txt:"DW",cls:"cellDW"},"#x5y13":{txt:"DW",cls:"cellDW"},"#x9y13":{txt:"DW",cls:"cellDW"},"#x7y11":{txt:"DW",cls:"cellDW"},"#x13y5":{txt:"DW",cls:"cellDW"},"#x13y9":{txt:"DW",cls:"cellDW"},"#x11y7":{txt:"DW",cls:"cellDW"},"#x6y0":{txt:"TL",cls:"cellTL"},"#x8y0":{txt:"TL",cls:"cellTL"},"#x6y14":{txt:"TL",cls:"cellTL"},"#x8y14":{txt:"TL",cls:"cellTL"},"#x0y6":{txt:"TL",cls:"cellTL"},"#x0y8":{txt:"TL",cls:"cellTL"},"#x14y6":{txt:"TL",cls:"cellTL"},"#x14y8":{txt:"TL",cls:"cellTL"},"#x3y3":{txt:"TL",cls:"cellTL"},"#x11y3":{txt:"TL",cls:"cellTL"},"#x3y11":{txt:"TL",cls:"cellTL"},"#x11y11":{txt:"TL",cls:"cellTL"},"#x5y5":{txt:"TL",cls:"cellTL"},"#x9y5":{txt:"TL",cls:"cellTL"},"#x5y9":{txt:"TL",cls:"cellTL"},"#x9y9":{txt:"TL",cls:"cellTL"},"#x1y2":{txt:"DL",cls:"cellDL"},"#x2y1":{txt:"DL",cls:"cellDL"},"#x13y2":{txt:"DL",cls:"cellDL"},"#x12y1":{txt:"DL",cls:"cellDL"},"#x1y12":{txt:"DL",cls:"cellDL"},"#x2y13":{txt:"DL",cls:"cellDL"},"#x13y12":{txt:"DL",cls:"cellDL"},"#x12y13":{txt:"DL",cls:"cellDL"},"#x2y4":{txt:"DL",cls:"cellDL"},"#x4y2":{txt:"DL",cls:"cellDL"},"#x2y10":{txt:"DL",cls:"cellDL"},"#x4y12":{txt:"DL",cls:"cellDL"},"#x12y4":{txt:"DL",cls:"cellDL"},"#x10y2":{txt:"DL",cls:"cellDL"},"#x12y10":{txt:"DL",cls:"cellDL"},"#x10y12":{txt:"DL",cls:"cellDL"},"#x4y6":{txt:"DL",cls:"cellDL"},"#x4y8":{txt:"DL",cls:"cellDL"},"#x6y4":{txt:"DL",cls:"cellDL"},"#x6y10":{txt:"DL",cls:"cellDL"},"#x10y6":{txt:"DL",cls:"cellDL"},"#x10y8":{txt:"DL",cls:"cellDL"},"#x8y4":{txt:"DL",cls:"cellDL"},"#x8y10":{txt:"DL",cls:"cellDL"},"#x7y7":{txt:"*",cls:"cellCenter"}};var gameInstance_AI={};var TaskAI={};var isDebugDivShown=false